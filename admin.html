<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel Newsletter</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
  h1 { text-align: center; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
  input[type=text], input[type=password] { width: 90%; padding: 6px; margin: 4px 0; }
  button { padding: 6px 12px; margin: 4px; cursor: pointer; }
  #loginForm, #panel { max-width: 600px; margin: auto; background: #fff; padding: 20px; border: 1px solid #ccc; }
  #addForm { margin-top: 20px; }
</style>
</head>
<body>

<div id="loginForm">
  <h2>Login Admin</h2>
  <input type="text" id="username" placeholder="Username"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="panel" style="display:none;">
  <h1>Admin Panel Newsletter</h1>

  <div id="addForm">
    <h3>Tambah Newsletter</h3>
    <input type="text" id="newsId" placeholder="ID Newsletter">
    <input type="text" id="newsDesc" placeholder="Deskripsi">
    <button onclick="addNewsletter()">Tambah</button>
  </div>

  <table id="newsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Deskripsi</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody>
      <!-- Daftar newsletter muncul di sini -->
    </tbody>
  </table>
</div>

<script>
/******** CONFIG ********/
const GITHUB_USER = 'meongHost'; // ganti username GitHub
const GITHUB_REPO = 'repo';     // ganti nama repo
const FILE_PATH = 'db.json';    // path file JSON di repo
const GITHUB_TOKEN = 'ghp_xxx'; // ganti dengan Personal Access Token (repo access)

/* login hardcoded */
const ADMIN_USER = 'admin';
const ADMIN_PASS = 'admin123';

let newsletterList = [];
let fileSha = ''; // SHA file untuk update GitHub API

/******** LOGIN ********/
function login() {
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  const msg = document.getElementById('loginMsg');

  if(user === ADMIN_USER && pass === ADMIN_PASS){
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('panel').style.display = 'block';
    loadNewsletter();
  } else {
    msg.innerText = 'Username atau password salah!';
  }
}

/******** LOAD NEWSLETTER ********/
async function loadNewsletter() {
  try {
    const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}`);
    const data = await res.json();
    fileSha = data.sha;
    const content = atob(data.content.replace(/\n/g,''));
    newsletterList = JSON.parse(content);
    renderTable();
  } catch(err) {
    console.error('Gagal load newsletter:', err);
  }
}

/******** RENDER TABLE ********/
function renderTable() {
  const tbody = document.querySelector('#newsTable tbody');
  tbody.innerHTML = '';
  newsletterList.forEach((item, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.id}</td>
      <td>${item.desc}</td>
      <td>
        <button onclick="removeNewsletter(${index})">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/******** ADD NEWSLETTER ********/
async function addNewsletter() {
  const id = document.getElementById('newsId').value.trim();
  const desc = document.getElementById('newsDesc').value.trim();
  if(!id || !desc) { alert('Isi semua field!'); return; }

  newsletterList.push({id, desc});
  renderTable();
  document.getElementById('newsId').value = '';
  document.getElementById('newsDesc').value = '';

  await updateGitHubFile();
}

/******** REMOVE NEWSLETTER ********/
async function removeNewsletter(index) {
  newsletterList.splice(index, 1);
  renderTable();
  await updateGitHubFile();
}

/******** UPDATE GITHUB FILE ********/
async function updateGitHubFile() {
  try {
    const content = btoa(JSON.stringify(newsletterList, null, 2));
    const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FILE_PATH}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Update newsletter',
        content: content,
        sha: fileSha
      })
    });
    const data = await res.json();
    if(data.content && data.content.sha){
      fileSha = data.content.sha;
      console.log('Update berhasil.');
    } else {
      console.error('Update gagal:', data);
    }
  } catch(err) {
    console.error('Gagal update GitHub:', err);
  }
}
</script>

</body>
</html>
