<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pengenalan Wajah dari Kamera</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0d1117;
      color: #eee;
      height: 100vh;
    }
    video, canvas {
      border-radius: 10px;
      box-shadow: 0 0 20px #00ffff55;
    }
    #error {
      margin-top: 20px;
      padding: 10px;
      background: #ff3333;
      color: white;
      border-radius: 5px;
      display: none;
      max-width: 640px;
      white-space: pre-line;
    }
    #loading {
      margin-top: 10px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h2>üé• Pengenalan Wajah dari Kamera</h2>
  <video id="video" width="640" height="480" autoplay muted></video>
  <canvas id="overlay" width="640" height="480"></canvas>
  <div id="loading">Memuat library Face API...</div>
  <div id="error"></div>

  <!-- ‚úÖ Face API Library -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const context = overlay.getContext('2d');
    const errorDiv = document.getElementById('error');
    const loadingText = document.getElementById('loading');

    // ‚úÖ URL model yang valid (repositori mirror publik)
    const MODEL_URL = "https://cdn.jsdelivr.net/gh/vladmandic/face-api/model/";

    async function init() {
      try {
        if (typeof faceapi === 'undefined') {
          throw new Error("Library face-api.js gagal dimuat dari CDN.");
        }

        loadingText.textContent = 'Memuat model AI... ‚è≥';

        // ‚úÖ Muat model yang tersedia di mirror publik
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
          faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
        ]);

        loadingText.textContent = 'Model berhasil dimuat ‚úÖ, mengaktifkan kamera...';
        await startCamera();
      } catch (err) {
        showError("‚ùå Gagal memuat model: " + err.message);
      }
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          loadingText.textContent = "Kamera aktif! üîç Sedang mendeteksi wajah...";
          detectLoop();
        };
      } catch (err) {
        showError(
          "‚ùå Gagal mengakses kamera: " + err.message +
          "\n\nSolusi:\n1Ô∏è‚É£ Jalankan file ini lewat server lokal (bukan file://)\n2Ô∏è‚É£ Gunakan http://localhost\n3Ô∏è‚É£ Pastikan kamera tidak digunakan aplikasi lain"
        );
      }
    }

    async function detectLoop() {
      const displaySize = { width: video.width, height: video.height };
      faceapi.matchDimensions(overlay, displaySize);

      async function loop() {
        try {
          const detections = await faceapi
            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceExpressions();

          context.clearRect(0, 0, overlay.width, overlay.height);
          const resizedDetections = faceapi.resizeResults(detections, displaySize);
          faceapi.draw.drawDetections(overlay, resizedDetections);
          faceapi.draw.drawFaceLandmarks(overlay, resizedDetections);
          faceapi.draw.drawFaceExpressions(overlay, resizedDetections);
        } catch (err) {
          console.error("Kesalahan deteksi:", err);
        }
        requestAnimationFrame(loop);
      }
      loop();
    }

    function showError(msg) {
      errorDiv.style.display = 'block';
      errorDiv.textContent = msg;
      loadingText.textContent = '‚ùå Terjadi kesalahan.';
      console.error(msg);
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
